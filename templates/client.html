<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">    
</head>
<body>
  <button id="btnSortir" onclick="leaveGame()" style="display: block;">
     <img src="{{ url_for('static', filename='btnSortir.png') }}" alt ="Sortir"/>
  </button>
  <div id="index">
    <h1 id="titre">Jeu de la Pi√®ce</h1>
    <div id="btnCouleur">
      <button id="themeClair" onclick="themeClair()">
        <span id="gauche"></span>
        <span id="droite"></span>
      </button>
      <button id="themeSombre" onclick="themeSombre()">
        <span id="gauche"></span>
        <span id="droite"></span>
      </button>
    </div>
    
    <!-- Conteneur horizontal pour input + bouton -->
    <div id="joinContainer">
      <input type="text" id="nomJoueur" placeholder="Entrez votre nom">
      <button onclick="rejoindreJeu()">Rejoindre le jeu</button>
    </div>

    <h3>Liste des joueurs :</h3>
    <div id="listeJoueurs"></div>
    <div id="commencer">
      <button onclick="commencerJeu()">START !</button>
    </div>
  </div>

  <div id="round" style="display: none;">
    <div id="PhrasePseudo"></div>
    <div id="LaQuestion"></div>
  </div>

  <div id="ChoixPileFace">
    <div class="option">
      <h2>Choisis entre Pile et Face</h2>
      <button id="btnPile" onclick="envoyerChoixP()">
        <img src="{{ url_for('static', filename='pile.png') }}" alt="PILE" />
      </button>
      <span>Pile</span>
    </div>
    <div class="option">
      <button id="btnFace" onclick="envoyerChoixF()">
        <img src="{{ url_for('static', filename='face.png') }}" alt="FACE" />
      </button>
      <span>Face</span>
    </div>
  </div>

  <div id="ResPileFace" style="display:none;">
    <div id="coin-container">
      <div id="coin">
        <div class="face front"><img src="{{ url_for('static', filename='pile.png') }}" alt="PILE" /></div>
        <div class="face back"><img src="{{ url_for('static', filename='face.png') }}" alt="FACE" /></div>
      </div>
    </div>
    <div id="resultat" style="margin-top:20px; font-size:20px; font-weight:bold;"></div>
  </div>
  <script>
    // Automatiser la s√©paration des lettres du titre
    const titre = document.getElementById('titre');
    const text = titre.textContent;
    titre.textContent = '';
    text.split('').forEach(char => {
      const span = document.createElement('span');
      span.textContent = char;
      titre.appendChild(span);
    });
  </script>
    
    <script>
        var socket = io({ transports: ['websocket'], upgrade: false });

        // -------- ROOMS --------
        var room = Math.random().toString(36).substring(2, 8); // id unique auto par client
        console.log("Room perso:", room);

        var choix;
        var questionActuelle = "";
        // ----------- FONCTION BOUTON THEME ---------

        function themeClair() {
  const root = document.documentElement;

  root.style.setProperty('--couleur1', '#FFD699');       // jaune clair
  root.style.setProperty('--couleur2', '#FF7F50');       // corail
  root.style.setProperty('--couleur3', '#FF5722');       // orange fonc√©

  root.style.setProperty('--couleur-texte', '#3B2F2F');
  root.style.setProperty('--couleur-accent', '#E67E22');
  root.style.setProperty('--couleur-border', '#FFA07A');
  root.style.setProperty('--couleur-focus', '#FF4500');

  root.style.setProperty('--joueur-bg', '#FFE4C4');
  root.style.setProperty('--coin-front', '#FF8C00');
  root.style.setProperty('--coin-back', '#D35400');

  root.style.setProperty('--white', '#FFFFFF');
  root.style.setProperty('--black', '#000000');
  root.style.setProperty('--couleur-index','#FFFFFF')
}
          function themeSombre() {
            const root = document.documentElement;
  root.style.setProperty('--couleur1', '#7d5abe'); 
  root.style.setProperty('--couleur2', '#4f32cf'); 
  root.style.setProperty('--couleur3', '#1c069b'); 
  root.style.setProperty('--couleur-texte', '#F0F0F0');
  root.style.setProperty('--couleur-accent', '#7D5FFF');
  root.style.setProperty('--couleur-border', '#7D5FFF');
  root.style.setProperty('--couleur-focus', '#B19CD9');
  root.style.setProperty('--joueur-bg', 'rgba(15, 15, 35, 0.9)');
  root.style.setProperty('--coin-front', '#7D5FFF');
  root.style.setProperty('--coin-back', '#4B0082');
  root.style.setProperty('--couleur-index','rgba(15, 15, 35, 0.7)');
} 

        // --------- FONCTIONS UTILITAIRES ---------
        function resetRound() {
            document.getElementById("round").style.display = 'none';
            document.getElementById("ChoixPileFace").style.display = 'none';
            document.getElementById("ResPileFace").style.display = 'none';

            const coin = document.getElementById("coin");
            const affichage = document.getElementById("resultat");
            coin.style.transition = "none";
            coin.style.transform = "rotateY(0deg)";
            affichage.textContent = "";

            document.getElementById("LaQuestion").innerHTML = "";
            document.getElementById("PhrasePseudo").innerHTML = "";
        }

        function afficherPieceAvantResultat() {
        const resDiv = document.getElementById("ResPileFace");
        const coin = document.getElementById("coin");
        const affichage = document.getElementById("resultat");

        // ‚¨áÔ∏è Nettoyage imm√©diat des √©l√©ments du round pr√©c√©dent
        const oldQ = document.getElementById("affQuest");
        if (oldQ) oldQ.remove();
        const oldBtnShow = document.getElementById("btnAfficherQuestion");
        if (oldBtnShow) oldBtnShow.remove();
        const oldBtnNew = document.getElementById("btnNewRound");
        if (oldBtnNew) oldBtnNew.remove();

        // reset visuel de la pi√®ce + efface le texte de r√©sultat
        resDiv.style.display = 'block';
        coin.style.transition = "none";
        coin.style.transform = "rotateY(0deg)";
        affichage.textContent = "";
        }


        // --------- FONCTIONS DE JEU ---------
        function rejoindreJeu() {
            const nomJoueur = document.getElementById("nomJoueur").value.trim();
            if (nomJoueur) {
                socket.emit('NouvJoueur', {room: room, pseudo: nomJoueur});
                document.getElementById("nomJoueur").value = "";
            } else {
                alert("Veuillez entrer un pseudo valide");
            }
        }
        
        function commencerJeu() {
            resetRound();
            document.getElementById("index").style.display = 'none';
            document.getElementById("round").style.display = 'block';
            socket.emit('lancerRound', {room: room});
            socket.emit('chargerQuestion', {room: room});
        }
        
        function demanderQuestion() {
            socket.emit('demandeQuestion', {room: room});
            document.getElementById("decrocher").style.display = 'none';
        }
        
        function afficherChoixPileFace() {
            document.getElementById("round").style.display = 'none';
            document.getElementById("ChoixPileFace").style.display = 'block';
        }
        
        function envoyerChoixP() {
            choix = "pile";
            afficherPieceAvantResultat();
            socket.emit("envoyerResPileFace", {room: room});
            document.getElementById("ChoixPileFace").style.display = 'none';
            document.getElementById("LaQuestion").innerHTML = "";
        }
        
        function envoyerChoixF() {
            choix = "face";
            afficherPieceAvantResultat();
            socket.emit("envoyerResPileFace", {room: room});
            document.getElementById("ChoixPileFace").style.display = 'none';
            document.getElementById("LaQuestion").innerHTML = "";
        }
        
        function lancerAnimationPileFace(resultat) {
            const coin = document.getElementById("coin");
            const affichage = document.getElementById("resultat");
            const round = document.getElementById('LaQuestion');

            let tours = 4;
            let angleFinal = (resultat === "pile") ? 0 : 180;

            coin.style.transition = "none";
            coin.style.transform = "rotateY(0deg)";
            void coin.offsetWidth;

            coin.style.transition = "transform 3s ease-out";
            coin.style.transform = `rotateY(${tours * 360 + angleFinal}deg)`;

            document.getElementById("ResPileFace").style.display = 'block';

            setTimeout(() => {
                affichage.textContent = (choix === resultat) ? "üéâ GAGN√â !" : "‚ùå PERDU !";
                affichage.style.color = (choix === resultat) ? "green" : "red";

                if (choix === resultat){
                    const ancienBtn = document.getElementById("btnAfficherQuestion");
                    if (ancienBtn) ancienBtn.remove();
                    let btnAfficherQuestion = document.createElement("button")
                    btnAfficherQuestion.id = "btnAfficherQuestion";
                    btnAfficherQuestion.textContent ="Afficher la question si p√©nalit√©"
                    let ancienQuest = document.getElementById("affQuest")
                    if (ancienQuest) ancienQuest.remove();
                    let affQuest = document.createElement("span")
                    affQuest.textContent = questionActuelle
                    affQuest.id="affQuest"
                    affQuest.style.display = 'none'
                    affichage.parentNode.appendChild(affQuest)
                    btnAfficherQuestion.onclick = () => {
                        affQuest.style.display ='block'
                        btnAfficherQuestion.style.display = 'none'
                    }
                    affichage.parentNode.appendChild(btnAfficherQuestion)
                }
                if (choix !== resultat){
                    let ancienQuest = document.getElementById("affQuest")
                    if (ancienQuest) ancienQuest.remove();
                    let affQuest = document.createElement("span")
                    affQuest.id="affQuest"
                    affQuest.textContent = questionActuelle
                    affichage.parentNode.appendChild(affQuest)
                }
                const ancienBtn = document.getElementById("btnNewRound");
                if (ancienBtn) ancienBtn.remove();
                let btnNewRound = document.createElement("button");
                btnNewRound.id = "btnNewRound"
                btnNewRound.textContent = "Nouveau Round";
                btnNewRound.onclick = () => {
                    socket.emit('lancerRound', {room: room});
                    resetRound();
                    document.getElementById("round").style.display = 'block';
                };
                affichage.parentNode.appendChild(btnNewRound);
            }, 3000);
        }
        
        function leaveGame() {
    // 1. Demande au serveur de reset la room
    socket.emit('resetRoom', { room: room });

    // 2. Reset visuel
    resetRound();
    document.getElementById("index").style.display = 'block';
    document.getElementById("round").style.display = 'none';
    document.getElementById("ChoixPileFace").style.display = 'none';
    document.getElementById("ResPileFace").style.display = 'none';

    // 3. R√©initialiser aussi la liste joueurs √† l'√©cran d'accueil
    document.getElementById("listeJoueurs").innerHTML = "";
}


        // --------- SOCKETS ---------
        socket.on('majListe', (liste) => {
    const zone = document.getElementById("listeJoueurs");
    zone.innerHTML = "";
    liste.forEach(joueur => {
        const joueurDiv = document.createElement("div");

        const nom = document.createElement("span");
        nom.textContent = joueur;

        const bouton = document.createElement("button");
        bouton.textContent = "‚ùå";
        bouton.onclick = () => {
            socket.emit('SupprimerJoueur', {room: room, pseudo: joueur});
        };

        joueurDiv.appendChild(nom);
        joueurDiv.appendChild(bouton);
        zone.appendChild(joueurDiv);
    });
});

        
        socket.on('AfficheNomJoueurR', (data) => {
            if (data) {
                const round = document.getElementById('PhrasePseudo');
                round.innerHTML = "";
        
                const phrase = document.createElement("span");
                phrase.textContent = data + " on t'appelle !";
        
                const bouton = document.createElement("button");
                bouton.id = "decrocher";
                bouton.textContent = "D√©crocher !";
                bouton.onclick = demanderQuestion;
        
                round.appendChild(phrase);
                round.appendChild(bouton);
            }
        });
        
        socket.on('AfficherQuestion', (data) => {
            if (data) {
                questionActuelle = data
                const round = document.getElementById('LaQuestion');
                round.innerHTML = "";
        
                const phrase = document.createElement("span");
                phrase.textContent = data;
        
                const bouton = document.createElement("button");
                bouton.textContent = "Suivant";
                bouton.onclick = afficherChoixPileFace;
        
                round.appendChild(phrase);
                round.appendChild(bouton);
            }
        });
        
        socket.on('ResPileFace', (data) => {
            lancerAnimationPileFace(data);
        });
    </script>
</body>
</html>
