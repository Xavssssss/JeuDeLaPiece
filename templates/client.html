<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <title>Jeu de la Pi√®ce</title>
</head>
<body>
  <!-- Bouton sortir -->
  <button id="btnSortir" onclick="leaveGame()">
    <img src="{{ url_for('static', filename='btnSortir.png') }}" alt="Sortir"/>
  </button>

  <!-- √âcran d'accueil -->
  <div id="index">
    <h1 id="titre">Jeu de la Pi√®ce</h1>

    <div id="joinContainer">
      <input type="text" id="nomJoueur" placeholder="Entrez votre nom">
      <button onclick="rejoindreJeu()">Rejoindre le jeu</button>
    </div>

    <h3>Liste des joueurs :</h3>
    <div id="listeJoueurs"></div>

    <div id="commencer">
      <button onclick="commencerJeu()">START !</button>
    </div>
  </div>

  <!-- √âcran de round (iPhone + √©crans internes) -->
  <div id="round" style="display:none;">
    <div id="iphoneContainer">
      <div class="iphone">
        <div class="notch"></div>

        <!-- √âcran d'appel -->
        <div id="callScreen" class="screen">
          <div class="call-time">12:34</div>
          <div class="call-text">üì± Appel entrant de</div>
          <div class="player-name" id="playerNamePhone">...</div>

          <!-- Swipe d√©crocher -->
          <div class="swipe-container">
            <div class="swipe-track">
              <div class="swipe-thumb" id="btnDecrocherPhone">üìû Glissez pour d√©crocher</div>
            </div>
          </div>
        </div>

        <!-- √âcran interm√©diaire (plus tard : ic√¥nes d'applis) -->
        <div id="appScreen" class="screen" style="display:none;">
          <h2>üì± Choisis une application</h2>
          <div class="apps-grid">
            <div class="app-icon" onclick="openTwitter()">üê¶</div>
            <div class="app-icon">üì∏</div>
            <div class="app-icon">üéÆ</div>
            <div class="app-icon">üéµ</div>
          </div>
        </div>

        <!-- √âcran Twitter -->
        <div id="twitterScreen" class="screen twitter">
          <div class="logo">üê¶ Twitter</div>
          <div class="question" id="questionPhone">...</div>
          <button id="btnContinuerJeu" class="continue-btn" onclick="afficherChoixPileFace()">Continuer</button>
        </div>

        <!-- √âcran Pile ou Face -->
        <div id="pileFaceScreen" class="screen" style="display:none;">
          <h2>Choisis entre Pile et Face</h2>
          <div class="options">
            <button id="btnPile" onclick="envoyerChoixP()">
              <img src="{{ url_for('static', filename='pile.png') }}" alt="PILE" />
            </button>
            <button id="btnFace" onclick="envoyerChoixF()">
              <img src="{{ url_for('static', filename='face.png') }}" alt="FACE" />
            </button>
          </div>

          <div id="coin-container">
            <div id="coin">
              <div class="face front"><img src="{{ url_for('static', filename='pile.png') }}" alt="PILE" /></div>
              <div class="face back"><img src="{{ url_for('static', filename='face.png') }}" alt="FACE" /></div>
            </div>
          </div>
        </div>

        <!-- √âcran R√©sultat -->
        <div id="resultScreen" class="screen">
          <div id="resultText"></div>
          <div id="questionResult" style="margin: 20px 0; font-size: 1em; display: none;"></div>
          <div id="btnApresRes">
            <button id="btnNewRound" onclick="nouveauRound()">Nouveau Round</button>
            <button id="AffQuestGagne" onclick="afficheQuestionResult()">Affiche question (si p√©nlait√©)</button>
          </div>
        </div>

      </div>
    </div>

    <div id="PhrasePseudo"></div>
    <div id="LaQuestion"></div>
  </div>

  <!-- SCRIPT JS -->
  <script>
    const titre = document.getElementById('titre');
    const text = titre.textContent;
    titre.textContent = '';
    text.split('').forEach(char => {
      const span = document.createElement('span');
      span.textContent = char;
      titre.appendChild(span);
    });

    var socket = io({ transports: ['websocket'], upgrade: false });
    var room = Math.random().toString(36).substring(2, 8);
    var choix;
    var questionActuelle = "";

    function resetRound() {
      document.getElementById("round").style.display = 'none';
      document.getElementById("index").style.display = 'block';
      document.getElementById("pileFaceScreen").style.display = 'none';
      document.getElementById("resultScreen").style.display = 'none';
      document.getElementById("twitterScreen").style.display = 'none';
      document.getElementById("callScreen").style.display = 'none';
    }

    function rejoindreJeu() {
      const nomJoueur = document.getElementById("nomJoueur").value.trim();
      if (nomJoueur) {
        socket.emit('NouvJoueur', {room: room, pseudo: nomJoueur});
        document.getElementById("nomJoueur").value = "";
      } else { alert("Veuillez entrer un pseudo valide"); }
    }

    function commencerJeu() {
      resetRound();
      document.getElementById("index").style.display = 'none';
      document.getElementById("round").style.display = 'block';
      document.getElementById("callScreen").style.display = 'flex';
      socket.emit('lancerRound', {room: room});
      socket.emit('chargerQuestion', {room: room});
    }

    function showPhoneCall(playerName) {
      document.getElementById("playerNamePhone").textContent = playerName;
      document.getElementById("callScreen").style.display = "flex";
    }

    function answerPhoneCall() {
      document.getElementById("callScreen").style.display = "none";
      document.getElementById("twitterScreen").style.display = "flex";
    }

    function showTwitterQuestion(question) {
      document.getElementById("questionPhone").textContent = question;
    }

    function afficherChoixPileFace() {
      document.getElementById("twitterScreen").style.display = 'none';
      document.getElementById("pileFaceScreen").style.display = 'flex';
    }

    function envoyerChoixP() { 
      choix = "pile";
      lancerAnimationPileFace("pile");
      socket.emit("envoyerResPileFace", {room: room});
    }

    function envoyerChoixF() { 
      choix = "face";
      lancerAnimationPileFace("face");
      socket.emit("envoyerResPileFace", {room: room});
    }

    function lancerAnimationPileFace(resultat) {
      const coin = document.getElementById("coin");
      const resultScreen = document.getElementById("resultScreen");
      const resultText = document.getElementById("resultText");
      const pileFaceScreen = document.getElementById("pileFaceScreen");

      let tours = 4;
      let angleFinal = (resultat === "pile") ? 0 : 180;
      coin.style.transition = "none";
      coin.style.transform = "rotateY(0deg)";
      void coin.offsetWidth;
      coin.style.transition = "transform 3s ease-out";
      coin.style.transform = `rotateY(${tours * 360 + angleFinal}deg)`;

      setTimeout(() => {
        pileFaceScreen.style.display = "none";
        resultScreen.style.display = "flex";
        const btn = document.getElementById("AffQuestGagne");
        resultText.textContent = (choix === resultat) ? "üéâ GAGN√â !" : "‚ùå PERDU !";
        resultText.className = (choix === resultat) ? "win" : "lose";
        const questionResult = document.getElementById("questionResult");
        if (choix !== resultat) {
        questionResult.textContent = "üí¨ Question pr√©c√©dente : " + questionActuelle;
        questionResult.style.display = "block";
        btn.style.display = "none";
        } else {
          questionResult.style.display = "none";
        }
      }, 3000);
    }

    function nouveauRound() {
      document.getElementById("resultScreen").style.display = "none";
      document.getElementById("callScreen").style.display = "flex";
      document.getElementById("AffQuestGagne").style.display = "none"
      socket.emit('lancerRound', {room: room});
      socket.emit('chargerQuestion', {room: room});
    }

    function leaveGame() {
      socket.emit('resetRoom', { room: room });
      resetRound();
      document.getElementById("index").style.display='block';
    }

    // Swipe d√©crocher
    (function setupSwipeThumb(){
      const thumb = document.getElementById("btnDecrocherPhone");
      const track = document.querySelector(".swipe-track");
      if (!thumb || !track) return;

      let startX = 0, currentX = 0, isDragging = false;
      function getMaxX() { return track.offsetWidth - thumb.offsetWidth; }

      function startDrag(e) {
        isDragging = true;
        startX = e.touches ? e.touches[0].clientX : e.clientX;
        currentX = 0;
        thumb.style.transition = 'none';
        document.addEventListener('mousemove', moveDrag);
        document.addEventListener('touchmove', moveDrag, {passive:false});
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
      }

      function moveDrag(e) {
        if (!isDragging) return;
        if (e.cancelable) e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        currentX = clientX - startX;
        if (currentX < 0) currentX = 0;
        const maxX = getMaxX();
        if (currentX > maxX) currentX = maxX;
        thumb.style.transform = `translateX(${currentX}px)`;
      }

      function endDrag() {
        if (!isDragging) return;
        isDragging = false;
        const maxX = getMaxX();
        if (currentX > maxX * 0.6) {
          thumb.style.transition = 'transform 0.2s';
          thumb.style.transform = `translateX(${maxX}px)`;
          thumb.textContent = "üìû Appel d√©croch√©";
          thumb.style.background = "rgba(50,205,50,0.9)";
          answerPhoneCall();
          socket.emit('demandeQuestion', {room: room});
        } else {
          thumb.style.transition = 'transform 0.2s';
          thumb.style.transform = `translateX(0)`;
        }
        document.removeEventListener('mousemove', moveDrag);
        document.removeEventListener('touchmove', moveDrag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);
      }

      thumb.addEventListener('mousedown', startDrag);
      thumb.addEventListener('touchstart', startDrag, {passive:false});
    })();

    function afficheQuestionResult(){
      const question = document.getElementById("questionResult");
      const btn = document.getElementById("AffQuestGagne");
      questionResult.textContent = "üí¨ Question pr√©c√©dente : " + questionActuelle; 
      questionResult.style.display = "block";
      btn.style.display = 'none';
    }

    socket.on('majListe', (liste) => {
      const zone=document.getElementById("listeJoueurs");
      zone.innerHTML="";
      liste.forEach(joueur=>{
        const joueurDiv=document.createElement("div");
        const nom=document.createElement("span");
        nom.textContent=joueur;
        const bouton=document.createElement("button");
        bouton.textContent="‚ùå";
        bouton.onclick=()=>{ socket.emit('SupprimerJoueur',{room:room,pseudo:joueur}); };
        joueurDiv.appendChild(nom);
        joueurDiv.appendChild(bouton);
        zone.appendChild(joueurDiv);
      });
    });

    socket.on('AfficheNomJoueurR',(data)=>{ if(data) showPhoneCall(data); });
    socket.on('AfficherQuestion',(data)=>{ if(data){ questionActuelle=data; showTwitterQuestion(data); } });
    socket.on('ResPileFace',(data)=>{ lancerAnimationPileFace(data); });
  </script>
</body>
</html>
