<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <title>Jeu de la PiÃ¨ce</title>
  <style>
    /* âœ… Style du bouton dÃ©crocher */
    .btnDecrocher {
      padding: 12px 25px;
      border: none;
      border-radius: 25px;
      background: linear-gradient(90deg, #00ff80, #00b33c);
      color: white;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btnDecrocher:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(0, 255, 128, 0.5);
    }
  </style>
</head>
<body>
  <!-- Bouton sortir -->
  <button id="btnSortir" onclick="leaveGame()">
    <img src="{{ url_for('static', filename='btnSortir.png') }}" alt="Sortir"/>
  </button>

  <!-- Ã‰cran d'accueil -->
  <div id="index">
    <h1 id="titre">Jeu de la PiÃ¨ce</h1>

    <div id="joinContainer">
      <input type="text" id="nomJoueur" placeholder="Entrez votre nom">
      <button onclick="rejoindreJeu()">Rejoindre le jeu</button>
    </div>

    <h3>Liste des joueurs :</h3>
    <div id="listeJoueurs"></div>

    <div id="commencer">
      <button onclick="commencerJeu()">START !</button>
    </div>
  </div>

  <!-- Ã‰cran de round -->
  <div id="round" style="display:none;">
    <div id="iphoneContainer">
      <div class="iphone">
        <div class="notch"></div>

        <!-- Ã‰cran d'appel -->
        <div id="callScreen" class="screen">
          <div class="call-time">12:34</div>
          <div class="call-text">ğŸ“± Appel entrant de</div>
          <div class="player-name" id="playerNamePhone">...</div>
          <button id="btnDecrocherPhone" class="btnDecrocher" onclick="decrocherAppel()">ğŸ“ DÃ©crocher</button>
        </div>

        <!-- Ã‰cran intermÃ©diaire -->
        <div id="appScreen" class="screen" style="display:none;">
          <h2>ğŸ“± Choisis une application</h2>
          <div class="apps-grid">
            <div class="app-icon" onclick="openTwitter()">ğŸ¦</div>
            <div class="app-icon">ğŸ“¸</div>
            <div class="app-icon">ğŸ®</div>
            <div class="app-icon">ğŸµ</div>
          </div>
        </div>

        <!-- Ã‰cran Twitter -->
        <div id="twitterScreen" class="screen twitter">
          <div class="logo">ğŸ¦ Twitter</div>
          <div class="question" id="questionPhone">...</div>
          <button id="btnContinuerJeu" class="continue-btn" onclick="afficherChoixPileFace()">Continuer</button>
        </div>

        <!-- Ã‰cran Pile ou Face -->
        <div id="pileFaceScreen" class="screen" style="display:none;">
          <h2>Choisis entre Pile et Face</h2>
          <div class="options">
            <button id="btnPile" onclick="envoyerChoixP()">
              <img src="{{ url_for('static', filename='pile.png') }}" alt="PILE" />
            </button>
            <button id="btnFace" onclick="envoyerChoixF()">
              <img src="{{ url_for('static', filename='face.png') }}" alt="FACE" />
            </button>
          </div>

          <div id="coin-container">
            <div id="coin">
              <div class="face front"><img src="{{ url_for('static', filename='pile.png') }}" alt="PILE" /></div>
              <div class="face back"><img src="{{ url_for('static', filename='face.png') }}" alt="FACE" /></div>
            </div>
          </div>
        </div>

        <!-- Ã‰cran RÃ©sultat -->
        <div id="resultScreen" class="screen">
          <div id="resultText"></div>
          <div id="questionResult" style="margin: 20px 0; font-size: 1em; display: none;"></div>
          <div id="btnApresRes">
            <button id="btnNewRound" onclick="nouveauRound()">Nouveau Round</button>
            <button id="AffQuestGagne" onclick="afficheQuestionResult()">Affiche question (si pÃ©nalitÃ©)</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- SCRIPT JS -->
  <script>
    const titre = document.getElementById('titre');
    const text = titre.textContent;
    titre.textContent = '';
    text.split('').forEach(char => {
      const span = document.createElement('span');
      span.textContent = char;
      titre.appendChild(span);
    });

    var socket = io({ transports: ['websocket'], upgrade: false });
    var room = Math.random().toString(36).substring(2, 8);
    var choix;
    var questionActuelle = "";

    function resetRound() {
      document.getElementById("round").style.display = 'none';
      document.getElementById("index").style.display = 'block';
      document.getElementById("pileFaceScreen").style.display = 'none';
      document.getElementById("resultScreen").style.display = 'none';
      document.getElementById("twitterScreen").style.display = 'none';
      document.getElementById("callScreen").style.display = 'none';
    }

    function rejoindreJeu() {
      const nomJoueur = document.getElementById("nomJoueur").value.trim();
      if (nomJoueur) {
        socket.emit('NouvJoueur', {room: room, pseudo: nomJoueur});
        document.getElementById("nomJoueur").value = "";
      } else { alert("Veuillez entrer un pseudo valide"); }
    }

    function commencerJeu() {
      resetRound();
      document.getElementById("index").style.display = 'none';
      document.getElementById("round").style.display = 'block';
      document.getElementById("callScreen").style.display = 'flex';
      socket.emit('lancerRound', {room: room});
      socket.emit('chargerQuestion', {room: room});
    }

    function showPhoneCall(playerName) {
      document.getElementById("playerNamePhone").textContent = playerName;
      document.getElementById("callScreen").style.display = "flex";
      const btn = document.getElementById("btnDecrocherPhone");
      btn.disabled = false;
      btn.textContent = "ğŸ“ DÃ©crocher";
      btn.style.background = "linear-gradient(90deg, #00ff80, #00b33c)";
    }

    function decrocherAppel() {
      const btn = document.getElementById("btnDecrocherPhone");
      btn.textContent = "ğŸ“ Appel dÃ©crochÃ© âœ…";
      btn.style.background = "linear-gradient(90deg, #00cc66, #008f3d)";
      btn.disabled = true;
      answerPhoneCall();
      socket.emit('demandeQuestion', {room: room});
    }

    function answerPhoneCall() {
      document.getElementById("callScreen").style.display = "none";
      document.getElementById("twitterScreen").style.display = "flex";
    }

    function showTwitterQuestion(question) {
      document.getElementById("questionPhone").textContent = question;
    }

    function afficherChoixPileFace() {
      document.getElementById("twitterScreen").style.display = 'none';
      document.getElementById("pileFaceScreen").style.display = 'flex';
    }

    function envoyerChoixP() { 
      choix = "pile";
      lancerAnimationPileFace("pile");
      socket.emit("envoyerResPileFace", {room: room});
    }

    function envoyerChoixF() { 
      choix = "face";
      lancerAnimationPileFace("face");
      socket.emit("envoyerResPileFace", {room: room});
    }

    function lancerAnimationPileFace(resultat) {
      const coin = document.getElementById("coin");
      const resultScreen = document.getElementById("resultScreen");
      const resultText = document.getElementById("resultText");
      const pileFaceScreen = document.getElementById("pileFaceScreen");

      let tours = 4;
      let angleFinal = (resultat === "pile") ? 0 : 180;
      coin.style.transition = "none";
      coin.style.transform = "rotateY(0deg)";
      void coin.offsetWidth;
      coin.style.transition = "transform 3s ease-out";
      coin.style.transform = `rotateY(${tours * 360 + angleFinal}deg)`;

      setTimeout(() => {
        pileFaceScreen.style.display = "none";
        resultScreen.style.display = "flex";
        const btn = document.getElementById("AffQuestGagne");
        const questionResult = document.getElementById("questionResult");

        resultText.textContent = (choix === resultat) ? "ğŸ‰ GAGNÃ‰ !" : "âŒ PERDU !";
        resultText.className = (choix === resultat) ? "win" : "lose";

        if (choix !== resultat) {
          questionResult.textContent = "ğŸ’¬ Question prÃ©cÃ©dente : " + questionActuelle;
          questionResult.style.display = "block";
          btn.style.display = "none";
        } else {
          questionResult.style.display = "none";
          btn.style.display = "inline-block";
        }
      }, 3000);
    }

    function nouveauRound() {
      const questionResult = document.getElementById("questionResult");
      const btn = document.getElementById("AffQuestGagne");
      questionResult.style.display = "none";
      btn.style.display = "inline-block";

      document.getElementById("resultScreen").style.display = "none";
      document.getElementById("callScreen").style.display = "flex";

      socket.emit('lancerRound', {room: room});
      socket.emit('chargerQuestion', {room: room});
    }

    function leaveGame() {
      socket.emit('resetRoom', { room: room });
      resetRound();
      document.getElementById("index").style.display='block';
    }

    function afficheQuestionResult(){
      const question = document.getElementById("questionResult");
      const btn = document.getElementById("AffQuestGagne");
      question.textContent = "ğŸ’¬ Question prÃ©cÃ©dente : " + questionActuelle; 
      question.style.display = "block";
      btn.style.display = 'none';
    }

    socket.on('majListe', (liste) => {
      const zone=document.getElementById("listeJoueurs");
      zone.innerHTML="";
      liste.forEach(joueur=>{
        const joueurDiv=document.createElement("div");
        const nom=document.createElement("span");
        nom.textContent=joueur;
        const bouton=document.createElement("button");
        bouton.textContent="âŒ";
        bouton.onclick=()=>{ socket.emit('SupprimerJoueur',{room:room,pseudo:joueur}); };
        joueurDiv.appendChild(nom);
        joueurDiv.appendChild(bouton);
        zone.appendChild(joueurDiv);
      });
    });

    socket.on('AfficheNomJoueurR',(data)=>{ if(data) showPhoneCall(data); });
    socket.on('AfficherQuestion',(data)=>{ if(data){ questionActuelle=data; showTwitterQuestion(data); } });
    socket.on('ResPileFace',(data)=>{ lancerAnimationPileFace(data); });
  </script>
</body>
</html>
